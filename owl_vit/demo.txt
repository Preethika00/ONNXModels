#!/bin/bash

# Path to main config and sweep config
MAIN_CONFIG="config.json"
SWEEP_CONFIG="sweep_configs.json"

# Parse the sweep configs using jq
len=$(jq length $SWEEP_CONFIG)

for ((i=0; i<$len; i++))
do
  # Extract values
  quant_scheme=$(jq -r ".[$i].quant_scheme" $SWEEP_CONFIG)
  output_bw=$(jq -r ".[$i].output_bw" $SWEEP_CONFIG)
  param_bw=$(jq -r ".[$i].param_bw" $SWEEP_CONFIG)

  echo "Running with quant_scheme=$quant_scheme, output_bw=$output_bw, param_bw=$param_bw"

  # Update config.json dynamically
  jq \
    --arg qs "$quant_scheme" \
    --argjson ob "$output_bw" \
    --argjson pb "$param_bw" \
    '.quant_scheme = $qs | .output_bw = $ob | .param_bw = $pb' \
    "$MAIN_CONFIG" > tmp_config.json && mv tmp_config.json "$MAIN_CONFIG"

  # Run your Python code (update the path to your main script if needed)
  python main.py --config "$MAIN_CONFIG"

  echo "---------------------------------------------"
done
